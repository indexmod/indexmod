<!DOCTYPE html>
<html lang="en">
<head>
  {% include meta-cover.html %}
  {% include favicon.html %}
  {% include yandex.html %}
  <style>
    .grid-container {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 20px;
      justify-content: center;
    }
    .grid-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .grid-item canvas {
      width: 100%;
      max-width: 250px;
      height: auto;
      aspect-ratio: 1 / 1;
    }
    .grid-item a {
      margin-top: 10px;
      text-decoration: none;
      color: #0073e6;
      font-weight: bold;
    }
    @media (max-width: 600px) {
      .grid-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <script type="importmap">
      {
          "imports": {
              "three": "https://unpkg.com/three@0.172.0/build/three.module.js",
              "three/addons/": "https://unpkg.com/three@0.172.0/examples/jsm/"
          }
      }
  </script>
</head>
<body>
  <h3>Indexmod Best 100 Grid</h3>
  <div class="grid-container">
    {% assign filtered_pages = site.pages | where: "top100", true %}
    {% for page in filtered_pages %}
      {% unless page.exclude %}
        <div class="grid-item">
          <canvas id="c-{{ page.permalink | slugify }}"></canvas>
          <a href="{{ page.url | relative_url }}">{{ page.title }}</a>
        </div>
      {% endunless %}
    {% endfor %}
  </div>

  <script type="module">
    import * as THREE from "three";
    import { TextureLoader } from "three";
    import { mergeGeometries } from "three/addons/utils/BufferGeometryUtils.js";

    const scenes = [];
    const renderers = [];
    const meshes = [];

    function init(canvasId, imageUrl) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const size = Math.min(canvas.parentElement.clientWidth, 250);

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(35, 1, 0.1, 20);
        camera.position.set(0, 0, 10);

        const renderer = new THREE.WebGLRenderer({
            canvas: canvas,
            antialias: true,
            alpha: true
        });
        renderer.setSize(size, size);
        renderer.setPixelRatio(window.devicePixelRatio || 1);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(5, 5, 5);
        scene.add(light);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        new TextureLoader().load(imageUrl, function (texture) {
            const material = new THREE.MeshStandardMaterial({
                roughness: 0,
                metalness: 1,
                envMapIntensity: 1.5,
                map: texture
            });

            const M = [];
            let p = new THREE.BoxGeometry(1, 1, 1);
            M.push(p);

            let m = p.clone();
            m.rotateY(Math.PI / 4);
            m.rotateX(Math.PI / 4);
            M.push(m);

            m = p.clone();
            m.rotateZ(Math.PI / 4);
            m.rotateX(Math.PI / 4);
            M.push(m);

            const geometry = mergeGeometries(M, false);
            const mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);

            scenes.push({ scene, camera });
            renderers.push(renderer);
            meshes.push(mesh);
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        for (let i = 0; i < meshes.length; i++) {
            meshes[i].rotation.y += 0.01;
            renderers[i].render(scenes[i].scene, scenes[i].camera);
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        {% for page in filtered_pages %}
        {% unless page.exclude %}
            init("c-{{ page.permalink | slugify }}", "{{ page.image }}");
        {% endunless %}
        {% endfor %}
        animate();
    });
  </script>
</body>
</html>
